<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="iron-search-ajax">
  <template>

    <iron-ajax
        id="search"
        url="https://api.spotify.com/v1/search"
        headers='{"Accept": "application/json"}'
        handle-as="json"
        last-response="{{data}}"
        debounce-duration="300">
    </iron-ajax>

    <app-indexeddb-mirror
        key="albums"
        data="[[data]]"
        persisted-data="{{response}}">
    </app-indexeddb-mirror>

  </template>

  <script>
    Polymer({
        is: 'iron-search-ajax',

        properties: {
            query: {
                type: String
            },
            response: {
                notify: true
            }
        },

        attached: function () {
            if(this.auto) {
                this.generateRequest();
            }
        },

        generateRequest: function () {
            if(this.query) {
                this._cancelCurrentRequest();
                this._performSearch();
            }
        },

        // Private methods
        _cancelCurrentRequest: function () {
            if (this.$.search.lastRequest) {
              this.$.search.lastRequest.abort();
            }
        },

        _performSearch: function () {
            this.$.search.params = {"q":this.query,"type":"album","limit":"50"};
            this.$.search.generateRequest();
        }
    });
  </script>
</dom-module>

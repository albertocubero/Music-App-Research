<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">

<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="iron-detail-ajax.html">

<dom-module id="album-detail">

  <template>

    <style include="shared-styles">

        .toolbar-header {
            color: white;
            --app-header-background-rear-layer: {
                background-color: #00AA8D;
            };
        }

        paper-icon-button {
            color: white;
            --paper-icon-button-ink-color: white;
        }

        .cover {
            padding-top: 300px;
            background-attachment: fixed;
            background-size: 100% auto;
            background-repeat: no-repeat;
            background-size: calc(100vw - 256px);
            background-position: top right;
        }

        .card-container {
            position: relative;
            width: 720px;
            margin: 0 auto;
        }

        paper-fab {
            position: absolute;
            top: -28px;
            right: 40px;
            --paper-fab-background: #EF5458;
            --paper-fab-keyboard-focus-background: #DF4448;
        }

        paper-card {
            padding: 16px 10px 16px 100px;
            width: 100%;
            sizing: border-box;
        }

        paper-card .card-content {
            padding-top: 0 !important;
        }

        paper-card .header {
            padding-bottom: 0 !important;
        }

        paper-card .info {
            border-bottom: 1px solid #ddd;
            font-size: 12px;
        }

        paper-card .extra {
            color: #999;
        }

        .section-title {
            margin: 60px 0 12px;
        }

        .track-item {
            margin: 20px 0;
            @apply(--layout-horizontal);
        }

        .track-number {
            margin-left: -80px;
            width: 60px;
            padding-right: 20px;
            color: rgb(33, 169, 143);
            text-align: right;
        }

        .track-duration {
            width: 60px;
            margin-right: 10px;
            text-align: left;
            color: #999;
        }

        .track-options {
            color: #999;
        }

        .track-name {
            @apply(--layout-flex);
            padding-right: 20px;
        }

        paper-toast {
            left: inherit !important;
            right: 0 !important;
        }

        @media (max-width: 1280px) {
            .cover {
                background-size: 100vw;
                background-position: inherit;
            }
        }

        @media (max-width: 720px) {
            .card-container {
                width: 100%;
                margin: 0;
            }
            paper-card {
                padding-left: 40px;
            }
        }

    </style>

    <paper-toast id="toast"></paper-toast>
    <iron-detail-ajax
        id="detailAjax"
        response="{{album}}">
    </iron-detail-ajax>
    <!-- main panel -->
    <app-header-layout>
        <app-header id="header" effects="waterfall fade-background toolbar-header" reveals>
            <!-- top toolbar -->
            <app-toolbar>
                <!-- back button -->
                <a href="#/home" tabindex="-1">
                    <paper-icon-button icon="arrow-back"></paper-icon-button>
                </a>
                <div main-title>Search</div>
                <div class="title">{{album.name}}</div>
                <paper-menu-button horizontal-align="right">
                    <paper-icon-button icon="more-vert" class="dropdown-trigger" alt="menu"></paper-icon-button>
                    <paper-listbox class="dropdown-content">
                        <paper-icon-item>
                            <iron-icon icon="share" item-icon></iron-icon>
                            Tweet album
                        </paper-icon-item>
                        <paper-icon-item>
                            <iron-icon icon="group" item-icon></iron-icon>
                            Share on Facebook
                        </paper-icon-item>
                    </paper-listbox>
                </paper-menu-button>
            </app-toolbar>
        </app-header>
        <div id="cover" class="fadein cover">
            <div id="cardContainer" class="card-container">
                <paper-card heading="{{album.name}}">
                    <div class="card-content">
                        <div class="info">
                            <p class="artist">{{album.artists.0.name}}</p>
                            <p class="extra">
                                <span class="date">{{_getYear(album.release_date)}}</span>
                                &#8226;
                                <span class="total-tracks">{{album.tracks.total}} {{_getTotalTracksText(album.tracks.total)}}</span>
                                &#8226;
                                <span class="duration">{{_getAlbumDuration(album.tracks.items)}}</span>
                            </p>
                        </div>
                        <h4 class="section-title">Tracks</h4>
                        <template is="dom-repeat" items="{{album.tracks.items}}">
                            <div class="track-item">
                                <div class="track-number">{{item.track_number}}</div>
                                <div class="track-name">{{item.name}}</div>
                                <div class="track-duration">{{_formatDuration(item.duration_ms)}}</div>
                                <div class="track-options">
                                    <iron-icon icon="icons:more-vert" item-icon></iron-icon>
                                </div>
                            </div>
                        </template>
                    </div>
                </paper-card>
                <paper-fab icon="{{__computeFavIcon(__favorite)}}" on-tap="onClickFavorite"></paper-fab>
            </div>
        </div>
    </app-header-layout>

  </template>

  <script>
  Polymer({
    is: 'album-detail',

    properties: {
      albumId: {
        type: Object,
        observer: '__albumIdChanged'
      },
      album: {
        type: Object,
        observer: '__albumChanged'
      },
      __favorite: {
        type: Boolean,
        value: false
      }
    },

    attached: function () {
        if(this.albumId) {
            this.$.detailAjax.query = this.albumId;
            this.$.detailAjax.generateRequest();
        }
    },

    onClickFavorite: function(event, detail) {
        this._updateFavorite();
        this._toggleAlbumOnLS();
        this._notifyFavoriteUpdated();
    },

    refresh: function () {
        this._updateFavoriteStatusFromLS();
    },

    __albumIdChanged: function () {
      this._removeCover();
      this._performRequest();
    },

    _performRequest: function () {
        this.$.detailAjax.query = this.albumId;
        this.$.detailAjax.generateRequest();
    },

    __albumChanged: function() {
        this._updateFavoriteStatusFromLS();
        this._updateCover();
    },

    _removeCover: function () {
        this.$.cover.style.backgroundImage = 'url()';
    },

    _updateCover: function () {
        if (this.album) {
            this.$.cover.style.backgroundImage = 'url(' + this.album.images[0].url + ')';
        }
    },

    _sendFavoriteEventUpdated: function () {
        this.fire('detail:updated', {
            id: this.album.id
        });
    },

    _updateFavorite: function () {
        this.__favorite = !this.__favorite;
    },

    _updateFavoriteStatusFromLS: function () {
        this.set('__favorite', window.App.localStorage.album.exist(this.album.id));
    },

    _toggleAlbumOnLS: function () {
        (this.__favorite) ? this._saveAlbumToLS(): this._removeAlbumToLS();
    },

    _saveAlbumToLS: function () {
        window.App.localStorage.album.save(this.album.id, this.album);
    },

    _removeAlbumToLS: function () {
        window.App.localStorage.album.remove(this.album.id);
    },

    __computeFavIcon: function(favorite) {
        return favorite ? 'favorite' : 'favorite-outline';
    },

    _getAlbumDuration: function (tracks) {
        if(tracks) {
            var duration = tracks.reduce(function (sum, item) {
                return sum + item.duration_ms;
            }, 0);

            return this._formatDuration(duration);
        }
    },

    _formatDuration: function (ms) {
        var date = new Date(ms);
        var minutes = date.getMinutes();
        var seconds = date.getSeconds();
        seconds = (seconds <= 9) ? '0'+seconds : seconds;
        return minutes+':'+seconds;
    },

    _getYear: function (date) {
        return (date) ? date.split('-')[0] : '';
    },

    _getTotalTracksText: function (tracks) {
        if(!tracks) return '';
        return (tracks <= 1) ? 'song' : 'songs';
    },

    _notifyFavoriteUpdated: function () {
        this._sendFavoriteEventUpdated();
        this._showMessage();
    },

    _showMessage: function () {
        var text = (this.__favorite) ? 'Favorite Saved !' : 'Favorite Removed !';
        this.$.toast.show(text);
    },
  });
  </script>

</dom-module>

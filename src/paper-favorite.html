<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="album-storage-manager.html">
<link rel="import" href="favorite-toast.html">

<dom-module id="paper-favorite">
  <style include="shared-styles">
      .btn-favorite.pink {
          color: var(--paper-pink-500);
          --paper-icon-button-ink-color: var(--paper-indigo-500);
      }
  </style>

  <template>
      <iron-signals on-iron-signal-favorite-updated="updateStatus"></iron-signals>

      <favorite-toast id="toast"></favorite-toast>

      <template is="dom-if" if="{{_isTruthy(status)}}">
          <paper-icon-button icon="icons:favorite" data-album-id="{{album.id}}" on-tap="onClickFavorite" class="btn-favorite pink"></paper-icon-button>
      </template>
      <template is="dom-if" if="{{_isFalsy(status)}}">
          <paper-icon-button icon="icons:favorite" data-album-id="{{album.id}}" on-tap="onClickFavorite" class="btn-favorite"></paper-icon-button>
      </template>

  </template>

  <script>

      Polymer({
        is: 'paper-favorite',
        properties: {
            status: {
                type: Boolean,
                value: false
            },
            album: {
                type: Object,
                value: {}
            },
        },
        attached: function () {
            this._updateFavoriteStatusFromLS();
        },
        updateStatus: function (data) {
            if(this.album.id === data.detail.albumId) {
                this._updateFavoriteStatusFromLS();
            }
        },
        onClickFavorite: function () {
            this._updateFavorite();
            this._toggleAlbumOnLS();
            this._notifyFavoriteUpdated();
        },
        _updateFavoriteStatusFromLS: function () {
            this.set('status', window.App.localStorage.album.exist(this.album.id));
        },
        _updateFavorite: function () {
            this.set('status', !window.App.localStorage.album.exist(this.album.id));
        },
        _toggleAlbumOnLS: function () {
            (this.get('status')) ? this._saveAlbumToLS(): this._removeAlbumToLS();
        },
        _saveAlbumToLS: function () {
            window.App.localStorage.album.save(this.album.id, this.album);
        },
        _removeAlbumToLS: function () {
            window.App.localStorage.album.remove(this.album.id);
        },
        _notifyFavoriteUpdated: function () {
            this._sendFavoriteEventUpdated();
            this._showMessage();
        },
        _sendFavoriteEventUpdated: function () {
            this.fire('iron-signal', {name: 'favorite-updated', data: {
                albumId: this.album.id
            }});
        },
        _showMessage: function () {
            this.$.toast.show(this.status);
        },
        _isTruthy: function (status) {
            return status === true;
        },
        _isFalsy: function (status) {
            return status === false;
        }
      });

  </script>

</dom-module>

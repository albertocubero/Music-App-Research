<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="iron-detail-ajax.html">

<dom-module id="iron-player">
  <template>
      <iron-detail-ajax
          id="detailAjax"
          response="{{albumDetail}}">
      </iron-detail-ajax>

      <iron-signals on-iron-signal-mysignal="stopPlayer"></iron-signals>

      <template is="dom-if" if="{{!playing}}">
          <paper-fab class="btn-play" icon="av:play-arrow" on-tap="_playAlbum"></paper-fab>
      </template>
      <template is="dom-if" if="{{playing}}">
          <paper-fab class="btn-play" icon="av:pause" on-tap="_pauseAlbum"></paper-fab>
      </template>

  </template>

  <script>

  (function () {

      Polymer({
        is: 'iron-player',
        properties: {
            albumId: {
                type: String,
                observer: '_albumIdChanged'
            },
            albumDetail: {
                type: Object,
                observer: '_albumDetailChanged'
            },
            playing: {
                type: Boolean,
                value: false
            },
            playerLoaded: {
                type: Boolean,
                value: false
            }
        },
        attached: function () {
            this._createPlayer();
        },

        stopPlayer: function () {
            this.player.stop();
        },

        _albumIdChanged: function () {
            this._createPlayer();
        },

        _createPlayer: function () {
            this.player = createPlayer();
        },

        _albumDetailChanged: function () {
            this._playSongs();
        },

        _playAlbum: function (e) {
            console.log('this.albumId: ', this.albumId);
            e.preventDefault();
            if (!this.albumDetail) {
                this.$.detailAjax.generateRequest(this.albumId);
            } else {
                this._playSongs();
            }
        },

        _playSongs: function () {
            if(this.get('playerLoaded')) {
                this.set('playing', true);
                this.player.play();
            }
            else {
                var songs = this.albumDetail.tracks.items.map(function (track) {
                    return track.preview_url;
                });
                this.set('playerLoaded', true);
                this.set('playing', true);
                this.player.load(songs);
            }
        },

        _pauseAlbum: function (e) {
            e.preventDefault();
            this.set('playing', false);
            this.player.pause();
        }
      });

      // CREATE FACTORY
      function createPlayer() {

          function createSongPlayer (url) {

              var ctx = new (window.AudioContext || window.webkitAudioContext)();
              var buffer;
              var sourceNode;
              var startedAt;
              var pausedAt;
              var paused;

              function load() {
                  var request = new XMLHttpRequest();
                  request.open('GET', url, true);
                  request.responseType = 'arraybuffer';
                  request.onload = function() {
                      ctx.decodeAudioData(request.response, onBufferLoad, onBufferError);
                  };
                  request.send();
              };

              function play() {
                  sourceNode = ctx.createBufferSource();
                  sourceNode.connect(ctx.destination);
                  sourceNode.buffer = buffer;
                  paused = false;

                  if (pausedAt) {
                      startedAt = Date.now() - pausedAt;
                      sourceNode.start(0, pausedAt / 1000);
                  }
                  else {
                      startedAt = Date.now();
                      sourceNode.start(0);
                  }
              };

              function stop() {
                  sourceNode.stop(0);
                  pausedAt = Date.now() - startedAt;
                  paused = true;
              };

              function onBufferLoad(b) {
                  buffer = b;
                  play();
              };

              function onBufferError(e) {
                  console.log('onBufferError', e);
              };

              load();

              return {
                  load: load,
                  play: play,
                  stop: stop
              }
          };

          var track;
          var playlist;
          var player;

          function load (songs) {
              init(songs);
              start();
          }

          function init (songs) {
              track = 0;
              playlist = parseSongs(songs);
              pause();
          }

          function parseSongs (songs) {
              if( typeof songs === 'string' ) {
                  songs = [songs];
              }
              return songs;
          }

          function start () {
              var song = getSong();
              if(song) {
                  createPlayer(song);
              }
          }

          function createPlayer (song) {
              player = createSongPlayer(song);
          }

          function getSong () {
              return playlist[track++];
          }

          function pause () {
              if(player) {
                  player.stop()
              }
          }

          function play () {
              if(player) {
                  player.play()
              }
          }

          function stop () {
              init(songs);
          }

          return {
              load: load,
              play: play,
              pause: pause,
              stop: stop
          };
      }

  })();


  </script>

</dom-module>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="iron-detail-ajax">
  <template>

    <iron-ajax
        id="detail"
        headers='{"Accept": "application/json"}'
        handle-as="json"
        last-response="{{data}}"
        debounce-duration="300">
    </iron-ajax>

    <app-indexeddb-mirror
        key="albums"
        data="[[data]]"
        persisted-data="{{response}}">
    </app-indexeddb-mirror>

  </template>

  <script>
    Polymer({
        is: 'iron-detail-ajax',

        properties: {
            query: {
                type: String
            },
            response: {
                notify: true
            }
        },

        attached: function () {
            if(this.auto) {
                this.generateRequest();
            }
        },

        generateRequest: function () {
            if(this.query) {
                this._cancelCurrentRequest();
                this._performDetail();
            }
        },

        // Private methods
        _cancelCurrentRequest: function () {
            if (this.$.detail.lastRequest) {
              this.$.detail.lastRequest.abort();
            }
        },

        _performDetail: function () {
            this.$.detail.url = "https://api.spotify.com/v1/albums/"+this.query;
            this.$.detail.generateRequest();
        }
    });
  </script>
</dom-module>

<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">

<link rel="import" href="album-storage-manager.html">
<link rel="import" href="favorite-toast.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="iron-player.html">

<dom-module id="album-card">

  <template>

    <style include="shared-styles">

        .card {
            display: inline-block;
            width: 31%;
            color: black;
            text-decoration: none;
            margin: 1%;
        }

        .card /deep/ .header {
            cursor: pointer;
        }

        .card /deep/ .header iron-image /deep/ img {
            height: 283px !important;
        }

        .btn-play {
            position: absolute;
            top: -28px;
            right: 20px;
            --paper-fab-background: #EF5458;
            --paper-fab-keyboard-focus-background: #DF4448;
        }

        .card-content {
            padding-right: 64px;
        }

        .info-artist-name {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding-right: 71px;
            font-weight: bold;
        }

        .info-title {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .btn-favorite.pink {
            color: var(--paper-pink-500);
            --paper-icon-button-ink-color: var(--paper-indigo-500);
        }

        .btn-external {
            color: inherit;
        }

        @media (max-width: 960px) {
            .card {
                width: 47.7%;
            }
            .card /deep/ .header iron-image /deep/ img {
                height: 362px !important;
            }
        }

        @media (max-width: 719px) {
            .card {
                width: 100%;
                margin: 3% 1%;
            }
            .card /deep/ .header iron-image /deep/ img {
                height: inherit !important;
            }
        }

    </style>

    <favorite-toast id="toast"></favorite-toast>
    <paper-card id="card" class="card" image="{{album.images.0.url}}" elevation="5">
        <a href="#/detail/{{album.id}}" class="card-container" style="color: inherit;text-decoration: inherit; position: relative;">
            <div class="card-content">
                <iron-player class="btn-play" id="player" album-id="{{album.id}}"></iron-player>
                <div class="info-artist-name">{{album.artists.0.name}}</div>
                <p class="info-title">{{album.name}}</p>
            </div>
        </a>
        <div class="card-actions">
            <template is="dom-if" if="{{_isTruthy(isFavorite)}}">
                <paper-icon-button icon="icons:favorite" data-album-id="{{album.id}}" on-tap="onClickFavorite" class="btn-favorite pink"></paper-icon-button>
            </template>
            <template is="dom-if" if="{{_isFalsy(isFavorite)}}">
                <paper-icon-button icon="icons:favorite" data-album-id="{{album.id}}" on-tap="onClickFavorite" class="btn-favorite"></paper-icon-button>
            </template>
            <a href="{{album.external_urls.spotify}}" target="_blank" class="btn-external">
                <paper-icon-button icon="icons:link"></paper-icon-button>
            </a>
        </div>
    </paper-card>

  </template>

  <script>
    Polymer({
        is: 'album-card',

        properties: {
            album: {
                type: Object,
                value: {},
                observer: '_albumChanged'
            },
            isFavorite: {
                type: Boolean,
                value: false
            },
        },

        attached: function () {
            this._createClickCoverHandler();
            this._initAlbumConfiguration();
        },

        onClickFavorite: function () {
            this._updateFavorite();
            this._toggleAlbumOnLS();
            this._notifyFavoriteUpdated();
        },

        refresh: function () {
            this._updateFavoriteStatusFromLS();
        },

        // Private methods
        _createClickCoverHandler: function () {
            this.clickCoverHandler = this._onClickCoverHandler.bind(this)
        },

        _onClickCoverHandler: function () {
            window.location.hash = '#/detail/'; // Needed to refresh detail view
            window.location.hash = '#/detail/' + this.album.id;
        },

        _albumChanged: function() {
            this._initAlbumConfiguration();
        },

        _initAlbumConfiguration: function () {
            this._addEventHandlers();
            this._updateFavoriteStatusFromLS();
            this._fadeInEffect();
        },

        _addEventHandlers: function () {
            // Hack
            try {
                // Chrome
                Polymer.dom(this.$.card).node.querySelector('::shadow .header').removeEventListener('click', this.clickCoverHandler);
                Polymer.dom(this.$.card).node.querySelector('::shadow .header').addEventListener('click', this.clickCoverHandler);
            }
            catch(err) {
                // Not Support - Firefox
                Polymer.dom(this.$.card).node.querySelector('.header').removeEventListener('click', this.clickCoverHandler);
                Polymer.dom(this.$.card).node.querySelector('.header').addEventListener('click', this.clickCoverHandler);
            }
        },

        _updateFavoriteStatusFromLS: function () {
            this.set('isFavorite', window.App.localStorage.album.exist(this.album.id));
        },

        _fadeInEffect: function () {
            $(this.$.card).removeClass('fadein').addClass('fadein');
        },

        _isTruthy: function (isFavorite) {
            return isFavorite === true;
        },

        _isFalsy: function (isFavorite) {
            return isFavorite === false;
        },

        _updateFavorite: function () {
            this.set('isFavorite', !this.isFavorite);
        },

        _toggleAlbumOnLS: function () {
            (this.isFavorite) ? this._saveAlbumToLS(): this._removeAlbumToLS();
        },

        _saveAlbumToLS: function () {
            window.App.localStorage.album.save(this.album.id, this.album);
        },

        _removeAlbumToLS: function () {
            window.App.localStorage.album.remove(this.album.id);
        },

        _notifyFavoriteUpdated: function () {
            this._sendFavoriteEventUpdated();
            this._showMessage();
        },

        _sendFavoriteEventUpdated: function () {
            this.fire('card:favorite:updated', {
                id: this.album.id
            });
        },

        _showMessage: function () {
            this.$.toast.show(this.isFavorite);
        }
    });
  </script>
</dom-module>
